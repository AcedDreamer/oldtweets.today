<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Your tweets on this day in the past</title>
    <meta name="description" content="The easiest way to download any video or GIF from Twitter ">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://metatags.io/">
    <meta property="og:title" content="this_vid: Download videos and GIFs off Twitter">
    <meta property="og:description" content="The easiest way to download any video or GIF from Twitter ">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="https://tweeted/">
    <meta property="twitter:title" content="">
    <meta property="twitter:description" content="The easiest way to download any video or GIF from Twitter ">


    <style>
        body {
            background: cadetblue;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', Calibri, sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            font-size: 1.5em;
            text-align: center;
        }

        h2 {
            text-align: center;
            padding-bottom: 6px;
        }
    </style>
</head>

<body>
<h2>See what you've tweeted on this day in the past.</h2>
<form onsubmit="handleFormSubmit(event);">
    <input type="text" name="username" placeholder="Your Twitter username" required>
    <button type="submit">Show me</button>
</form>

<div id="tweets-container"></div>
<script>
    // prefill the value if the user is coming from a direct link
    if (window.location.pathname
        && !window.location.pathname.includes('index.html')
        && window.location.pathname != '/') {
        document.querySelector('input[name="username"]').value = queryParams.get('username');
    } else {
        // or try query string
        let queryString = window.location.search;
        let queryParams = new URLSearchParams(queryString);
        if (queryParams.get('username')) {
            document.querySelector('input[name="username"]').value = queryParams.get('username');
        }
    }
</script>

<script>
    /**
     * @param {Event} event
     */
    function handleFormSubmit(event) {
        let username = event.target.querySelector('input[name="username"]').value;
        username = username.trim();
        getTweetsOnThisDay(username)
            .then(tweets => {
                let tweetsHtml = [];
                for (let year of Object.keys(tweets).reverse()) {
                    if (tweets[year].length) {
                        tweetsHtml.push(`<div>`);
                        tweetsHtml.push(`<h3>${year}</h3>`);
                        tweetsHtml.push(tweets[year].join("\n"));
                        tweetsHtml.push("</div><br>");
                    }
                }
                injectContentIntoPage(tweetsHtml.join("\n"), true);
                document.title = "Old Tweets by @" + username.replace("@", "");
                window.history.pushState({ username },"", username);
            })
            .catch(injectContentIntoPage);
        event.preventDefault();
    }

    /**
     * @param {string} username
     */
    function getTweetsOnThisDay(username) {
        const apiUrl = `https://europe-west1-tweetedonthisday.cloudfunctions.net/getTweetsOnThisDay?username=${username}`;
        return fetch(apiUrl).then(r => r.json())
            .then(r => {
                if (r.error) {
                    console.log(r.error);
                    throw 'Something went wrong. Please try again.ðŸ˜­';
                }
                return r;
            })
            .catch(r => {
                if (r.error) {
                    console.log(r.error);
                }
                throw 'Something went wrong. Please try again.ðŸ˜­';
            })
    }

    /**
     * @param {string} content
     * @param {boolean} isTwitterResponse
     */
    function injectContentIntoPage(content, isTwitterResponse = false) {
        let container = document.getElementById('tweets-container');
        container.innerHTML = content;
        if (isTwitterResponse) {
            twttr.widgets.load(container);
        }
    }
</script>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</body>
